<html>
<head>
	<link rel="stylesheet" href="client/css/main.css">
</head>
<body>
<div id="events"></div>

<!-- <script src="client/js/client.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>
	var socket = io();
	socket.on('message', writeEvent);
	socket.on('letter_basket_init', showLetterBasket);
	socket.on('new_letter_basket', showLetterBasket);

	var emptyCell = [];

	$(document).on('click','.basket-letter-btn',function(){
		var clonedBtn = $(this).clone().removeClass('basket-letter-btn').addClass('rack-letter-btn').attr('parent', $(this).parent().attr('id'));
		$("#rack").append(clonedBtn);
		$(this).remove();
	});

	$(document).on('click','.rack-letter-btn',function(){
		var clonedBtn = $(this).clone().removeClass('rack-letter-btn').addClass('basket-letter-btn').removeAttr('parent');
		$('#'+$(this).attr('parent')).append(clonedBtn);
		$(this).remove();
	});

	function writeEvent(text){
	  $('#message-container').html(text);
		setTimeout(function(){
			$("#message-container").empty();
		},3000);
	};

	function showLetterBasket(data) {
		var clonedTable = $("#table-to-clone").clone().attr('id', 'letter-basket');
		$("#init-basket").empty().append(clonedTable);
		$( "#letter-basket" ).find('td').each(function( index ) {
			var clonedBtn = $("#button-to-clone").clone().attr('id', 'btn'+index).addClass('basket-letter-btn').attr('data-points', data.basket[index].points);
			clonedBtn.text(data.basket[index].character);
			$( this ).append(clonedBtn);
		});

		if (!data.turn) {
			$("#submit-btn > button").attr('disabled', true);
			$('.basket-letter-btn').attr('disabled', true);
			$("#refresh-basket-btn > button").attr('disabled', true);
			writeEvent("Opponent's Turn");
		}
	}

	function submitLetters(){
		var word = ""
		if ($('.rack-letter-btn').length) {
			emptyCell = [];
			$('#rack').find('.rack-letter-btn').each(function( index ) {
				word += $(this).text();
				emptyCell.push($(this).attr('parent'));
			});
			socket.emit('submit_word', word);
		}
	}

	function refreshBasket() {
		socket.emit('refresh_basket');
		$("#rack").empty();
	}

	socket.on('generated_letters', function(data){
		data.forEach((letter, index) => {
			var clonedBtn = $("#button-to-clone").clone().addClass('basket-letter-btn').removeAttr('id').text(letter.character).attr('disabled', true).attr('data-points', letter.points);
			$('#'+emptyCell[index]).append(clonedBtn);
		})
	});

	socket.on('opponent_word', function(word) {
		$("#rack").empty();
		for (var i = 0; i < word.length; i++) {
			var clonedBtn = $("#button-to-clone").clone().removeAttr('id');
			clonedBtn.text(word.charAt(i));
			$("#rack").append(clonedBtn);
		}

		writeEvent("Opponent's word:");

		setTimeout(function(){
			$("#rack").empty();
			writeEvent("Your turn");
		}, 3000);
	});

	socket.on('word_accepted', function(message) {
		socket.emit('generate_letters', $('.rack-letter-btn').length);
		$("#rack").empty();
	});

	socket.on('your_turn', function(message) {
		$("#submit-btn > button").attr('disabled', false);
		$('.basket-letter-btn').attr('disabled', false);
		$('#refresh-basket-btn > button').attr('disabled', false);
		// writeEvent("Your turn!");
	});

	socket.on('change_turn', function(message) {
		$("#submit-btn > button").attr('disabled', true);
		$('.basket-letter-btn').attr('disabled', true);
		$('#refresh-basket-btn > button').attr('disabled', true);
		writeEvent("Opponent's Turn")
	});
	
</script>

<div id="message-container"></div>
<div id="rack"></div>
<div id="submit-btn"><button onclick="submitLetters()" >Submit</button></div>

<div id="init-basket"></div>

<div id="refresh-basket-btn"><button onclick="refreshBasket()">Refresh</button></div>


<table id="table-to-clone" align="center">
	<tr><td id="td1"></td><td id="td2"></td><td id="td3"></td><td id="td4"></td></tr>
	<tr><td id="td5"></td><td id="td6"></td><td id="td7"></td><td id="td8"></td></tr>
	<tr><td id="td9"></td><td id="td10"></td><td id="td11"></td><td id="td12"></td></tr>
</table>

<button id="button-to-clone"></button>

</body>
</html>
